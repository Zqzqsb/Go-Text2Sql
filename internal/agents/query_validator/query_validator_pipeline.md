## 查询验证器工作管线

> 查询验证器(QueryValidator)是一个混合规则与LLM能力的智能组件，旨在识别模糊查询并生成澄清问题，确保系统能够理解用户的真实查询意图。它通过规则匹配与语义分析的双重验证，实现了高准确度的模糊查询检测。

## 工作流程概述

> 查询验证器采用多阶段处理流程，包括初始规则检测、LLM语义分析和结果融合，确保对模糊查询的全面识别，同时能为识别到的模糊查询生成针对性的澄清问题。

### 泳道图表示

```mermaid
sequenceDiagram
    participant U as 用户
    participant QV as QueryValidator
    participant RM as 规则匹配器
    participant LLM as 大语言模型
    participant CG as 澄清问题生成器
    participant RP as 结果处理器

    Note over U,RP: 查询验证工作流
    
    U->>QV: 发送自然语言查询
    activate QV
    
    QV->>RM: 使用规则检测模糊性
    activate RM
    Note over RM: 检查模糊词汇<br>匹配模糊模式<br>识别占位符
    RM-->>QV: 返回规则检测结果
    deactivate RM
    
    alt 规则检测为模糊(占位符)
        QV->>CG: 直接生成澄清问题
        activate CG
        CG-->>QV: 返回澄清问题
        deactivate CG
    else 规则检测结果不确定或启用LLM
        QV->>LLM: 发送语义分析请求
        activate LLM
        Note over LLM: 语义理解<br>上下文分析<br>生成JSON响应
        LLM-->>QV: 返回LLM分析结果
        deactivate LLM
        
        QV->>QV: 解析LLM响应
        
        alt LLM检测为模糊
            QV->>CG: 合并规则与LLM结果生成澄清问题
            activate CG
            CG-->>QV: 返回澄清问题
            deactivate CG
        end
    end
    
    QV->>RP: 处理最终结果
    activate RP
    Note over RP: 结果打包<br>元数据添加<br>后续动作建议
    RP-->>QV: 返回最终处理结果
    deactivate RP
    
    QV-->>U: 返回验证结果与澄清问题
    deactivate QV
```

## 详细处理阶段

### 1. 初始化阶段

> 查询验证器初始化时配置了规则匹配器和可选的LLM客户端，为后续处理奠定基础。

```mermaid
flowchart TD
    A[开始] --> B[加载模糊词汇库]
    B --> C[编译正则表达式模式]
    C --> D[初始化LLM连接<br>如果启用]
    D --> E[初始化完成]
```

### 2. 规则匹配阶段

> 规则匹配阶段通过预定义的模式快速筛选明显的模糊查询，提供高效的一级过滤。

```mermaid
flowchart LR
    A[接收查询] --> B{检查模糊词汇}
    B -->|匹配| C[标记为模糊]
    B -->|不匹配| D{检查正则模式}
    D -->|匹配| C
    D -->|不匹配| E{检查占位符}
    E -->|匹配| C
    E -->|不匹配| F[标记为可能明确]
    C --> G[规则结果]
    F --> G
```

### 3. LLM分析阶段

> LLM分析阶段利用大语言模型的语义理解能力进行深度分析，特别是对于规则无法确定的情况，提供更加智能的判断。

```mermaid
flowchart TB
    A[接收查询] --> B[构建LLM提示]
    B --> C[发送到DeepSeek模型]
    C --> D[接收JSON格式响应]
    D --> E[解析响应]
    E --> F{是否模糊}
    F -->|是| G[提取模糊原因<br>和缺失信息]
    F -->|否| H[标记为明确查询]
    G --> I[LLM分析结果]
    H --> I
```

### 4. 结果融合阶段

> 结果融合阶段综合规则和LLM的判断，依据置信度和特定规则进行权衡，确保最终结果的可靠性。

```mermaid
flowchart TD
    A[规则结果] --> C{规则判定为模糊?}
    B[LLM结果] --> C
    C -->|是| D{LLM判定为明确<br>置信度>0.8?}
    C -->|否| E{LLM判定为模糊<br>置信度>0.7?}
    D -->|是| F[最终判定为明确]
    D -->|否| G[最终判定为模糊]
    E -->|是| G
    E -->|否| F
    G --> H[生成澄清问题]
    F --> I[返回明确结果]
    H --> J[返回模糊结果<br>和澄清问题]
```

### 5. 澄清问题生成阶段

> 澄清问题生成阶段针对不同类型的模糊性创建有针对性的问题，帮助用户提供更明确的信息。

```mermaid
flowchart LR
    A[接收模糊查询] --> B{模糊类型分析}
    B --> C[基于规则生成问题]
    B --> D[基于LLM缺失信息生成问题]
    C --> E[按优先级排序]
    D --> E
    E --> F[返回澄清问题列表]
```

## 实现细节

### 规则匹配部分

规则匹配系统主要由以下组件构成：
- 模糊词汇库：包含"特定"、"某个"等表示不明确的词汇
- 正则表达式模式：匹配占位符、ID模式等结构化模式
- 占位符检测：识别明显的占位符如"[请输入]"、"..."等

### LLM集成部分

LLM集成通过以下方式实现：
- 构建结构化提示：指导LLM以JSON格式返回分析结果
- 响应解析：从LLM响应中提取JSON部分并转换为结构化数据
- 置信度评估：利用LLM返回的置信度进行结果权衡

### 澄清问题生成部分

澄清问题生成遵循以下原则：
- 针对性：基于模糊性类型生成相关问题
- 优先级：为不同类型的问题分配优先级
- 组合能力：能够同时使用规则生成和LLM生成的问题

## 异常处理机制

```mermaid
flowchart TD
    A[开始处理] --> B{LLM调用失败?}
    B -->|是| C[回退到规则结果]
    B -->|否| D{JSON解析错误?}
    D -->|是| E[使用简单字符串匹配]
    D -->|否| F[正常处理]
    C --> G[返回结果]
    E --> G
    F --> G
```

## 未来改进方向

1. **模糊性评分系统**：为查询添加更细粒度的模糊性评分
2. **上下文感知**：考虑用户历史查询作为判断依据
3. **预训练优化**：针对特定领域训练LLM提高准确性
4. **反馈学习**：从用户反馈中学习，持续改进判断能力
